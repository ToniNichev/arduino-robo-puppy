<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoboPuppy Controller</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .connection-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .connection-panel h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .connection-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .port-select {
            flex: 1;
            min-width: 200px;
        }

        select, button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select {
            background: white;
            border: 2px solid #dee2e6;
            width: 100%;
        }

        button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            font-weight: 600;
            min-width: 120px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .disconnect-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .status {
            margin-top: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        .controls-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .control-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }

        .control-panel h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }

        .basic-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .basic-controls button {
            padding: 15px;
            font-size: 14px;
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .leg-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .leg-control {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #dee2e6;
        }

        .leg-control h4 {
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
        }

        .leg-controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .joint-control {
            text-align: center;
        }

        .joint-control label {
            display: block;
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .joint-control input {
            width: 100%;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
        }

        .joint-control button {
            width: 100%;
            padding: 8px;
            font-size: 12px;
            background: linear-gradient(135deg, #6f42c1, #5a32a3);
            margin-top: 8px;
        }

        .response-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border: 2px solid #e9ecef;
        }

        .response-panel h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .response-log {
            background: #212529;
            color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* Sequence Builder Styles */
        .sequence-builder {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sequence-controls {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 10px;
            align-items: end;
        }

        .sequence-controls select,
        .sequence-controls input {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .sequence-controls button {
            padding: 10px 15px;
            font-size: 14px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sequence-controls button:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .sequence-list h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .sequence-steps {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
        }

        .empty-sequence {
            color: #6c757d;
            text-align: center;
            font-style: italic;
            margin: 20px 0;
        }

        .sequence-step {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }

        .sequence-step .step-info {
            flex: 1;
        }

        .sequence-step .step-command {
            font-weight: 600;
            color: #495057;
        }

        .sequence-step .step-delay {
            font-size: 12px;
            color: #6c757d;
        }

        .sequence-step .step-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 5px;
        }

        .sequence-step .step-edit {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 5px;
        }

        .sequence-step .step-save {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 5px;
        }

        .sequence-step .step-cancel {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 5px;
        }

        .sequence-step .edit-inputs {
            display: none;
            gap: 5px;
            align-items: center;
            margin-top: 8px;
        }

        .sequence-step .edit-inputs input {
            padding: 4px 6px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
            width: 80px;
        }

        .sequence-step.editing .step-info {
            display: none;
        }

        .sequence-step.editing .edit-inputs {
            display: flex;
        }

        /* Drag and Drop Styles */
        .sequence-step {
            cursor: move;
            transition: all 0.2s ease;
        }

        .sequence-step:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .sequence-step.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
        }

        .sequence-step.drag-over {
            border-left: 4px solid #ffc107;
            background: #fff3cd;
        }

        .sequence-step.drag-over-top {
            border-top: 3px solid #007bff;
        }

        .sequence-step.drag-over-bottom {
            border-bottom: 3px solid #007bff;
        }

        .drag-handle {
            cursor: grab;
            padding: 2px 5px;
            margin-right: 5px;
            color: #6c757d;
            font-size: 14px;
            user-select: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .sequence-step .step-actions {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sequence-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .sequence-actions button {
            padding: 12px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .clear-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .save-btn {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .load-btn {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .execute-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .sequence-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .sequence-presets {
            border-top: 2px solid #dee2e6;
            padding-top: 20px;
        }

        .sequence-presets h4 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .preset-btn {
            padding: 12px;
            font-size: 14px;
            background: linear-gradient(135deg, #6f42c1, #5a32a3);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .preset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Voice Control Styles */
        .voice-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .voice-btn {
            padding: 15px 25px;
            font-size: 16px;
            background: linear-gradient(135deg, #e83e8c, #d63384);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .voice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .voice-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .voice-btn.listening {
            background: linear-gradient(135deg, #28a745, #20c997);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .voice-status {
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }

        .voice-status.ready {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .voice-status.listening {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #99d6ff;
        }

        .voice-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .voice-command {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            min-height: 40px;
            text-align: center;
            color: #495057;
        }

        .voice-command.active {
            border-color: #007bff;
            background: #e3f2fd;
            color: #0056b3;
        }

        .voice-help {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #dee2e6;
        }

        .voice-help h4 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .voice-commands-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .voice-category {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px 15px;
            font-size: 14px;
            line-height: 1.4;
        }

        .voice-category strong {
            color: #007bff;
            display: block;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .content {
                padding: 20px;
            }
            
            .connection-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-row {
                grid-template-columns: 1fr;
            }
            
            .leg-controls {
                grid-template-columns: 1fr;
            }
            
            .leg-controls-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .control-panel {
                padding: 20px;
            }
            
            .sequence-controls {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .sequence-actions {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .preset-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .sequence-step .edit-inputs {
                flex-direction: column;
                gap: 8px;
            }
            
            .sequence-step .edit-inputs input,
            .sequence-step .edit-inputs select {
                width: 100% !important;
            }
        }

        @media (max-width: 480px) {
            .leg-controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 RoboPuppy Controller</h1>
            <p>Control your Arduino robot through the web interface</p>
        </div>

        <div class="content">
            <!-- Connection Panel -->
            <div class="connection-panel">
                <h3>🔌 Connection</h3>
                <div class="connection-controls">
                    <div class="port-select">
                        <select id="portSelect">
                            <option value="">Select Arduino Port...</option>
                        </select>
                    </div>
                    <button id="refreshPorts">🔄 Refresh</button>
                    <button id="connectBtn">🔗 Connect</button>
                    <button id="disconnectBtn" disabled>❌ Disconnect</button>
                </div>
                <div id="connectionStatus" class="status disconnected">Disconnected</div>
            </div>

            <!-- Voice Control Panel -->
            <div class="connection-panel">
                <h3>🎤 Voice Control</h3>
                <div class="voice-controls">
                    <button id="voiceToggleBtn" class="voice-btn">🎤 Start Voice Control</button>
                    <div id="voiceStatus" class="voice-status">Voice control ready</div>
                    <div id="voiceCommand" class="voice-command"></div>
                </div>
                <div class="voice-help">
                    <h4>Voice Commands:</h4>
                    <div class="voice-commands-list">
                        <div class="voice-category">
                            <strong>Basic Commands:</strong> "stand", "sit", "walk", "neutral", "down"
                        </div>
                        <div class="voice-category">
                            <strong>Leg Control:</strong> "move leg [0-3] [hip/knee] [angle]"
                        </div>
                        <div class="voice-category">
                            <strong>Sequences:</strong> "execute sequence", "dance", "wave", "exercise"
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls Grid -->
            <div class="controls-grid">
                <!-- First Row: Basic Controls and Leg Controls -->
                <div class="controls-row">
                    <!-- Basic Controls -->
                    <div class="control-panel">
                        <h3>🎮 Basic Controls</h3>
                        <div class="basic-controls">
                            <button onclick="sendCommand('stand')">Stand</button>
                            <button onclick="sendCommand('sit')">Sit</button>
                            <button onclick="sendCommand('walk')">Walk</button>
                            <button onclick="sendCommand('neutral')">Neutral</button>
                            <button onclick="sendCommand('down')">Down</button>
                            <button onclick="sendCommand('help')">Help</button>
                        </div>
                    </div>

                    <!-- Leg Controls -->
                    <div class="control-panel">
                        <h3>🦵 Leg Controls</h3>
                        <div class="leg-controls">
                            <div class="leg-control">
                                <h4>Leg 0 (Front Left)</h4>
                                <div class="leg-controls-grid">
                                    <div class="joint-control">
                                        <label>Hip</label>
                                        <input type="number" id="leg0Hip" min="-90" max="90" value="0">
                                        <button onclick="moveLeg(0, 'hip')">Move</button>
                                    </div>
                                    <div class="joint-control">
                                        <label>Knee</label>
                                        <input type="number" id="leg0Knee" min="-90" max="90" value="0">
                                        <button onclick="moveLeg(0, 'knee')">Move</button>
                                    </div>
                                </div>
                            </div>

                            <div class="leg-control">
                                <h4>Leg 1 (Front Right)</h4>
                                <div class="leg-controls-grid">
                                    <div class="joint-control">
                                        <label>Hip</label>
                                        <input type="number" id="leg1Hip" min="-90" max="90" value="0">
                                        <button onclick="moveLeg(1, 'hip')">Move</button>
                                    </div>
                                    <div class="joint-control">
                                        <label>Knee</label>
                                        <input type="number" id="leg1Knee" min="-90" max="90" value="0">
                                        <button onclick="moveLeg(1, 'knee')">Move</button>
                                    </div>
                                </div>
                            </div>

                            <div class="leg-control">
                                <h4>Leg 2 (Back Left)</h4>
                                <div class="leg-controls-grid">
                                    <div class="joint-control">
                                        <label>Hip</label>
                                        <input type="number" id="leg2Hip" min="-90" max="90" value="0">
                                        <button onclick="moveLeg(2, 'hip')">Move</button>
                                    </div>
                                    <div class="joint-control">
                                        <label>Knee</label>
                                        <input type="number" id="leg2Knee" min="-90" max="90" value="0">
                                        <button onclick="moveLeg(2, 'knee')">Move</button>
                                    </div>
                                </div>
                            </div>

                            <div class="leg-control">
                                <h4>Leg 3 (Back Right)</h4>
                                <div class="leg-controls-grid">
                                    <div class="joint-control">
                                        <label>Hip</label>
                                        <input type="number" id="leg3Hip" min="-90" max="90" value="0">
                                        <button onclick="moveLeg(3, 'hip')">Move</button>
                                    </div>
                                    <div class="joint-control">
                                        <label>Knee</label>
                                        <input type="number" id="leg3Knee" min="-90" max="90" value="0">
                                        <button onclick="moveLeg(3, 'knee')">Move</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Second Row: Command Sequences (Full Width) -->
                <div class="control-panel">
                    <h3>🎭 Command Sequences</h3>
                    <div class="sequence-builder">
                        <div class="sequence-controls">
                            <select id="commandSelect">
                                <option value="">Select Command...</option>
                                <option value="stand">Stand</option>
                                <option value="sit">Sit</option>
                                <option value="walk">Walk</option>
                                <option value="neutral">Neutral</option>
                                <option value="down">Down</option>
                                <optgroup label="Leg Commands">
                                    <option value="leg0hip">Leg 0 Hip</option>
                                    <option value="leg0knee">Leg 0 Knee</option>
                                    <option value="leg1hip">Leg 1 Hip</option>
                                    <option value="leg1knee">Leg 1 Knee</option>
                                    <option value="leg2hip">Leg 2 Hip</option>
                                    <option value="leg2knee">Leg 2 Knee</option>
                                    <option value="leg3hip">Leg 3 Hip</option>
                                    <option value="leg3knee">Leg 3 Knee</option>
                                </optgroup>
                            </select>
                            <input type="number" id="angleInput" placeholder="Angle (-90 to 90)" min="-90" max="90" style="display: none;">
                            <input type="number" id="delayInput" placeholder="Delay (ms)" min="0" value="1000" step="100">
                            <button onclick="addToSequence()">➕ Add</button>
                        </div>
                        
                        <div class="sequence-list">
                            <h4>Sequence Steps:</h4>
                            <div id="sequenceSteps" class="sequence-steps">
                                <p class="empty-sequence">No commands in sequence</p>
                            </div>
                        </div>
                        
                        <div class="sequence-actions">
                            <button onclick="clearSequence()" class="clear-btn">🗑️ Clear</button>
                            <button onclick="saveSequence()" class="save-btn">💾 Save</button>
                            <button onclick="loadSequence()" class="load-btn">📁 Load</button>
                            <button onclick="executeSequence()" class="execute-btn">▶️ Execute</button>
                        </div>
                        
                        <div class="sequence-presets">
                            <h4>Quick Presets:</h4>
                            <div class="preset-buttons">
                                <button onclick="loadPreset('dance')" class="preset-btn">💃 Dance</button>
                                <button onclick="loadPreset('greeting')" class="preset-btn">👋 Greeting</button>
                                <button onclick="loadPreset('exercise')" class="preset-btn">🏃 Exercise</button>
                                <button onclick="loadPreset('wave')" class="preset-btn">👋 Wave</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Response Panel -->
            <div class="response-panel">
                <h3>📡 Arduino Response</h3>
                <div id="responseLog" class="response-log">Waiting for connection...</div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let isConnected = false;

        // DOM elements
        const portSelect = document.getElementById('portSelect');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const refreshBtn = document.getElementById('refreshPorts');
        const statusDiv = document.getElementById('connectionStatus');
        const responseLog = document.getElementById('responseLog');

        // Socket events
        socket.on('robot-response', (data) => {
            addToLog(`Response: ${data.message}`);
        });

        socket.on('connect', () => {
            addToLog('Connected to server');
        });

        socket.on('disconnect', () => {
            addToLog('Disconnected from server');
        });

        // Event listeners
        refreshBtn.addEventListener('click', refreshPorts);
        connectBtn.addEventListener('click', connectToRobot);
        disconnectBtn.addEventListener('click', disconnectFromRobot);

        // Functions
        async function refreshPorts() {
            try {
                const response = await fetch('/api/ports');
                const data = await response.json();
                
                portSelect.innerHTML = '<option value="">Select Arduino Port...</option>';
                data.ports.forEach(port => {
                    const option = document.createElement('option');
                    option.value = port.path;
                    option.textContent = `${port.path} - ${port.description || 'Unknown'}`;
                    portSelect.appendChild(option);
                });
                
                addToLog(`Found ${data.ports.length} ports`);
            } catch (error) {
                addToLog(`Error refreshing ports: ${error.message}`);
            }
        }

        async function connectToRobot() {
            const port = portSelect.value;
            if (!port) {
                alert('Please select a port first');
                return;
            }

            try {
                const response = await fetch('/api/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port })
                });

                const data = await response.json();
                
                if (data.success) {
                    isConnected = true;
                    updateConnectionStatus(true);
                    addToLog(`Connected to ${port}`);
                } else {
                    addToLog(`Connection failed: ${data.message}`);
                }
            } catch (error) {
                addToLog(`Connection error: ${error.message}`);
            }
        }

        async function disconnectFromRobot() {
            try {
                const response = await fetch('/api/disconnect', {
                    method: 'POST'
                });

                const data = await response.json();
                
                isConnected = false;
                updateConnectionStatus(false);
                addToLog(data.message);
            } catch (error) {
                addToLog(`Disconnect error: ${error.message}`);
            }
        }

        function updateConnectionStatus(connected) {
            isConnected = connected;
            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
            portSelect.disabled = connected;
            
            if (connected) {
                statusDiv.textContent = 'Connected';
                statusDiv.className = 'status connected';
            } else {
                statusDiv.textContent = 'Disconnected';
                statusDiv.className = 'status disconnected';
            }
        }

        function sendCommand(command) {
            if (!isConnected) {
                alert('Please connect to the robot first');
                return;
            }

            socket.emit('robot-command', { command });
            addToLog(`Sent command: ${command}`);
        }

        function moveLeg(legId, joint) {
            if (!isConnected) {
                alert('Please connect to the robot first');
                return;
            }

            const inputId = `leg${legId}${joint.charAt(0).toUpperCase() + joint.slice(1)}`;
            const angle = parseFloat(document.getElementById(inputId).value);
            
            if (isNaN(angle) || angle < -90 || angle > 90) {
                alert('Please enter a valid angle between -90 and 90');
                return;
            }

            socket.emit('robot-command', { 
                command: 'leg', 
                legId: legId, 
                joint: joint, 
                angle: angle 
            });
            
            addToLog(`Sent: leg ${legId} ${joint} ${angle}`);
        }

        function addToLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            responseLog.textContent += `[${timestamp}] ${message}\n`;
            responseLog.scrollTop = responseLog.scrollHeight;
        }

        // Command Sequence Variables
        let currentSequence = [];
        let isExecuting = false;
        let draggedElement = null;
        let draggedIndex = null;

        // Voice Control Variables
        let recognition = null;
        let isListening = false;
        let voiceSupported = false;

        // Command Select Change Handler
        document.getElementById('commandSelect').addEventListener('change', function() {
            const angleInput = document.getElementById('angleInput');
            const command = this.value;
            
            // Show angle input for leg commands
            if (command.startsWith('leg')) {
                angleInput.style.display = 'block';
                angleInput.required = true;
            } else {
                angleInput.style.display = 'none';
                angleInput.required = false;
            }
        });

        // Sequence Builder Functions
        function addToSequence() {
            if (!isConnected) {
                alert('Please connect to the robot first');
                return;
            }

            const commandSelect = document.getElementById('commandSelect');
            const angleInput = document.getElementById('angleInput');
            const delayInput = document.getElementById('delayInput');

            const command = commandSelect.value;
            const delay = parseInt(delayInput.value) || 1000;

            if (!command) {
                alert('Please select a command');
                return;
            }

            if (command.startsWith('leg')) {
                const angle = parseFloat(angleInput.value);
                if (isNaN(angle) || angle < -90 || angle > 90) {
                    alert('Please enter a valid angle between -90 and 90');
                    return;
                }
                
                // Parse leg command
                const legId = parseInt(command.charAt(3));
                const joint = command.substring(4);
                
                currentSequence.push({
                    type: 'leg',
                    legId: legId,
                    joint: joint,
                    angle: angle,
                    delay: delay,
                    displayText: `Leg ${legId} ${joint} ${angle}° (${delay}ms delay)`
                });
            } else {
                currentSequence.push({
                    type: 'command',
                    command: command,
                    delay: delay,
                    displayText: `${command} (${delay}ms delay)`
                });
            }

            updateSequenceDisplay();
            
            // Reset inputs
            commandSelect.value = '';
            angleInput.style.display = 'none';
            angleInput.value = '';
            delayInput.value = '1000';
        }

        function updateSequenceDisplay() {
            const sequenceSteps = document.getElementById('sequenceSteps');
            
            if (currentSequence.length === 0) {
                sequenceSteps.innerHTML = '<p class="empty-sequence">No commands in sequence</p>';
                return;
            }

            sequenceSteps.innerHTML = '';
            currentSequence.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'sequence-step';
                stepDiv.id = `step-${index}`;
                stepDiv.draggable = true;
                stepDiv.dataset.index = index;
                
                // Create edit inputs based on step type
                let editInputs = '';
                if (step.type === 'leg') {
                    editInputs = `
                        <div class="edit-inputs">
                            <label>Leg:</label>
                            <select id="edit-leg-${index}" style="width: 60px;">
                                <option value="0" ${step.legId === 0 ? 'selected' : ''}>0</option>
                                <option value="1" ${step.legId === 1 ? 'selected' : ''}>1</option>
                                <option value="2" ${step.legId === 2 ? 'selected' : ''}>2</option>
                                <option value="3" ${step.legId === 3 ? 'selected' : ''}>3</option>
                            </select>
                            <label>Joint:</label>
                            <select id="edit-joint-${index}" style="width: 60px;">
                                <option value="hip" ${step.joint === 'hip' ? 'selected' : ''}>Hip</option>
                                <option value="knee" ${step.joint === 'knee' ? 'selected' : ''}>Knee</option>
                            </select>
                            <label>Angle:</label>
                            <input type="number" id="edit-angle-${index}" value="${step.angle}" min="-90" max="90" style="width: 70px;">
                            <label>Delay:</label>
                            <input type="number" id="edit-delay-${index}" value="${step.delay}" min="0" step="100" style="width: 70px;">
                            <button class="step-save" onclick="saveStepEdit(${index})">✓</button>
                            <button class="step-cancel" onclick="cancelStepEdit(${index})">✕</button>
                        </div>
                    `;
                } else {
                    editInputs = `
                        <div class="edit-inputs">
                            <label>Command:</label>
                            <select id="edit-command-${index}" style="width: 120px;">
                                <option value="stand" ${step.command === 'stand' ? 'selected' : ''}>Stand</option>
                                <option value="sit" ${step.command === 'sit' ? 'selected' : ''}>Sit</option>
                                <option value="walk" ${step.command === 'walk' ? 'selected' : ''}>Walk</option>
                                <option value="neutral" ${step.command === 'neutral' ? 'selected' : ''}>Neutral</option>
                                <option value="down" ${step.command === 'down' ? 'selected' : ''}>Down</option>
                            </select>
                            <label>Delay:</label>
                            <input type="number" id="edit-delay-${index}" value="${step.delay}" min="0" step="100" style="width: 70px;">
                            <button class="step-save" onclick="saveStepEdit(${index})">✓</button>
                            <button class="step-cancel" onclick="cancelStepEdit(${index})">✕</button>
                        </div>
                    `;
                }
                
                stepDiv.innerHTML = `
                    <div class="step-info">
                        <span class="drag-handle">⋮⋮</span>
                        <div class="step-command">${index + 1}. ${step.displayText}</div>
                    </div>
                    ${editInputs}
                    <div class="step-actions">
                        <button class="step-edit" onclick="editStep(${index})">✏️</button>
                        <button class="step-remove" onclick="removeFromSequence(${index})">🗑️</button>
                    </div>
                `;
                
                // Add drag and drop event listeners
                stepDiv.addEventListener('dragstart', handleDragStart);
                stepDiv.addEventListener('dragover', handleDragOver);
                stepDiv.addEventListener('drop', handleDrop);
                stepDiv.addEventListener('dragend', handleDragEnd);
                stepDiv.addEventListener('dragenter', handleDragEnter);
                stepDiv.addEventListener('dragleave', handleDragLeave);
                
                sequenceSteps.appendChild(stepDiv);
            });
        }

        function removeFromSequence(index) {
            currentSequence.splice(index, 1);
            updateSequenceDisplay();
        }

        function editStep(index) {
            const stepDiv = document.getElementById(`step-${index}`);
            stepDiv.classList.add('editing');
        }

        function cancelStepEdit(index) {
            const stepDiv = document.getElementById(`step-${index}`);
            stepDiv.classList.remove('editing');
        }

        function saveStepEdit(index) {
            const step = currentSequence[index];
            
            if (step.type === 'leg') {
                // Update leg command
                const newLegId = parseInt(document.getElementById(`edit-leg-${index}`).value);
                const newJoint = document.getElementById(`edit-joint-${index}`).value;
                const newAngle = parseFloat(document.getElementById(`edit-angle-${index}`).value);
                const newDelay = parseInt(document.getElementById(`edit-delay-${index}`).value);
                
                // Validate inputs
                if (isNaN(newAngle) || newAngle < -90 || newAngle > 90) {
                    alert('Please enter a valid angle between -90 and 90');
                    return;
                }
                
                if (isNaN(newDelay) || newDelay < 0) {
                    alert('Please enter a valid delay (0 or greater)');
                    return;
                }
                
                // Update step
                step.legId = newLegId;
                step.joint = newJoint;
                step.angle = newAngle;
                step.delay = newDelay;
                step.displayText = `Leg ${newLegId} ${newJoint} ${newAngle}° (${newDelay}ms delay)`;
                
            } else {
                // Update basic command
                const newCommand = document.getElementById(`edit-command-${index}`).value;
                const newDelay = parseInt(document.getElementById(`edit-delay-${index}`).value);
                
                // Validate inputs
                if (isNaN(newDelay) || newDelay < 0) {
                    alert('Please enter a valid delay (0 or greater)');
                    return;
                }
                
                // Update step
                step.command = newCommand;
                step.delay = newDelay;
                step.displayText = `${newCommand} (${newDelay}ms delay)`;
            }
            
            // Exit edit mode and refresh display
            cancelStepEdit(index);
            updateSequenceDisplay();
            addToLog(`Updated step ${index + 1} in sequence`);
        }

        function clearSequence() {
            currentSequence = [];
            updateSequenceDisplay();
        }

        async function executeSequence() {
            if (!isConnected) {
                alert('Please connect to the robot first');
                return;
            }

            if (currentSequence.length === 0) {
                alert('No commands in sequence');
                return;
            }

            if (isExecuting) {
                alert('Sequence is already executing');
                return;
            }

            isExecuting = true;
            const executeBtn = document.querySelector('.execute-btn');
            executeBtn.disabled = true;
            executeBtn.textContent = '⏳ Executing...';

            addToLog(`Starting sequence execution (${currentSequence.length} steps)`);

            try {
                for (let i = 0; i < currentSequence.length; i++) {
                    const step = currentSequence[i];
                    
                    addToLog(`Executing step ${i + 1}: ${step.displayText}`);
                    
                    if (step.type === 'leg') {
                        socket.emit('robot-command', {
                            command: 'leg',
                            legId: step.legId,
                            joint: step.joint,
                            angle: step.angle
                        });
                    } else {
                        socket.emit('robot-command', { command: step.command });
                    }

                    // Wait for the specified delay (except for the last step)
                    if (i < currentSequence.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, step.delay));
                    }
                }
                
                addToLog('Sequence execution completed!');
            } catch (error) {
                addToLog(`Sequence execution error: ${error.message}`);
            } finally {
                isExecuting = false;
                executeBtn.disabled = false;
                executeBtn.textContent = '▶️ Execute';
            }
        }

        function saveSequence() {
            if (currentSequence.length === 0) {
                alert('No sequence to save');
                return;
            }

            const sequenceName = prompt('Enter a name for this sequence:');
            if (!sequenceName) return;

            const sequenceData = {
                name: sequenceName,
                steps: currentSequence,
                timestamp: new Date().toISOString()
            };

            localStorage.setItem(`sequence_${sequenceName}`, JSON.stringify(sequenceData));
            addToLog(`Sequence "${sequenceName}" saved successfully`);
        }

        function loadSequence() {
            const savedSequences = [];
            
            // Get all saved sequences from localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('sequence_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        savedSequences.push({
                            key: key,
                            name: data.name,
                            steps: data.steps.length,
                            timestamp: data.timestamp
                        });
                    } catch (e) {
                        // Skip invalid entries
                    }
                }
            }

            if (savedSequences.length === 0) {
                alert('No saved sequences found');
                return;
            }

            // Create selection dialog
            let message = 'Select a sequence to load:\n\n';
            savedSequences.forEach((seq, index) => {
                const date = new Date(seq.timestamp).toLocaleDateString();
                message += `${index + 1}. ${seq.name} (${seq.steps} steps, saved ${date})\n`;
            });

            const choice = prompt(message + '\nEnter the number:');
            const choiceNum = parseInt(choice);

            if (choiceNum >= 1 && choiceNum <= savedSequences.length) {
                const selected = savedSequences[choiceNum - 1];
                const sequenceData = JSON.parse(localStorage.getItem(selected.key));
                
                currentSequence = sequenceData.steps;
                updateSequenceDisplay();
                addToLog(`Loaded sequence "${selected.name}" with ${selected.steps} steps`);
            }
        }

        function loadPreset(presetName) {
            clearSequence();
            
            switch (presetName) {
                case 'dance':
                    currentSequence = [
                        { type: 'command', command: 'stand', delay: 500, displayText: 'stand (500ms delay)' },
                        { type: 'leg', legId: 0, joint: 'hip', angle: 30, delay: 300, displayText: 'Leg 0 hip 30° (300ms delay)' },
                        { type: 'leg', legId: 1, joint: 'hip', angle: -30, delay: 300, displayText: 'Leg 1 hip -30° (300ms delay)' },
                        { type: 'leg', legId: 2, joint: 'hip', angle: 30, delay: 300, displayText: 'Leg 2 hip 30° (300ms delay)' },
                        { type: 'leg', legId: 3, joint: 'hip', angle: -30, delay: 500, displayText: 'Leg 3 hip -30° (500ms delay)' },
                        { type: 'command', command: 'neutral', delay: 1000, displayText: 'neutral (1000ms delay)' }
                    ];
                    break;
                    
                case 'greeting':
                    currentSequence = [
                        { type: 'command', command: 'sit', delay: 500, displayText: 'sit (500ms delay)' },
                        { type: 'leg', legId: 0, joint: 'knee', angle: 45, delay: 300, displayText: 'Leg 0 knee 45° (300ms delay)' },
                        { type: 'leg', legId: 0, joint: 'knee', angle: 0, delay: 500, displayText: 'Leg 0 knee 0° (500ms delay)' },
                        { type: 'leg', legId: 0, joint: 'knee', angle: 45, delay: 300, displayText: 'Leg 0 knee 45° (300ms delay)' },
                        { type: 'leg', legId: 0, joint: 'knee', angle: 0, delay: 500, displayText: 'Leg 0 knee 0° (500ms delay)' },
                        { type: 'command', command: 'stand', delay: 1000, displayText: 'stand (1000ms delay)' }
                    ];
                    break;
                    
                case 'exercise':
                    currentSequence = [
                        { type: 'command', command: 'stand', delay: 500, displayText: 'stand (500ms delay)' },
                        { type: 'command', command: 'sit', delay: 1000, displayText: 'sit (1000ms delay)' },
                        { type: 'command', command: 'stand', delay: 1000, displayText: 'stand (1000ms delay)' },
                        { type: 'command', command: 'down', delay: 1000, displayText: 'down (1000ms delay)' },
                        { type: 'command', command: 'stand', delay: 1000, displayText: 'stand (1000ms delay)' }
                    ];
                    break;
                    
                case 'wave':
                    currentSequence = [
                        { type: 'command', command: 'sit', delay: 500, displayText: 'sit (500ms delay)' },
                        { type: 'leg', legId: 1, joint: 'knee', angle: 60, delay: 300, displayText: 'Leg 1 knee 60° (300ms delay)' },
                        { type: 'leg', legId: 1, joint: 'hip', angle: -45, delay: 300, displayText: 'Leg 1 hip -45° (300ms delay)' },
                        { type: 'leg', legId: 1, joint: 'hip', angle: 45, delay: 500, displayText: 'Leg 1 hip 45° (500ms delay)' },
                        { type: 'leg', legId: 1, joint: 'hip', angle: -45, delay: 500, displayText: 'Leg 1 hip -45° (500ms delay)' },
                        { type: 'leg', legId: 1, joint: 'hip', angle: 0, delay: 300, displayText: 'Leg 1 hip 0° (300ms delay)' },
                        { type: 'leg', legId: 1, joint: 'knee', angle: 0, delay: 500, displayText: 'Leg 1 knee 0° (500ms delay)' },
                        { type: 'command', command: 'stand', delay: 1000, displayText: 'stand (1000ms delay)' }
                    ];
                    break;
            }
            
            updateSequenceDisplay();
            addToLog(`Loaded "${presetName}" preset with ${currentSequence.length} steps`);
        }

        // Drag and Drop Functions
        function handleDragStart(e) {
            draggedElement = this;
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over', 'drag-over-top', 'drag-over-bottom');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                const dropIndex = parseInt(this.dataset.index);
                
                // Remove the dragged element from the array
                const draggedStep = currentSequence.splice(draggedIndex, 1)[0];
                
                // Insert it at the new position
                currentSequence.splice(dropIndex, 0, draggedStep);
                
                // Update the display
                updateSequenceDisplay();
                addToLog(`Moved step ${draggedIndex + 1} to position ${dropIndex + 1}`);
            }

            this.classList.remove('drag-over', 'drag-over-top', 'drag-over-bottom');
            return false;
        }

        function handleDragEnd(e) {
            const elements = document.querySelectorAll('.sequence-step');
            elements.forEach(element => {
                element.classList.remove('dragging', 'drag-over', 'drag-over-top', 'drag-over-bottom');
            });
            
            draggedElement = null;
            draggedIndex = null;
        }

        // Voice Recognition Functions
        function initializeVoiceRecognition() {
            // Check for browser support
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                // Configure recognition settings
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                // Event handlers
                recognition.onstart = function() {
                    isListening = true;
                    updateVoiceStatus('listening', 'Listening...');
                    updateVoiceButton('listening', '🎤 Listening...');
                };
                
                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    const voiceCommandDiv = document.getElementById('voiceCommand');
                    if (finalTranscript) {
                        voiceCommandDiv.textContent = finalTranscript;
                        voiceCommandDiv.classList.add('active');
                        processVoiceCommand(finalTranscript.trim());
                    } else if (interimTranscript) {
                        voiceCommandDiv.textContent = interimTranscript;
                        voiceCommandDiv.classList.remove('active');
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    updateVoiceStatus('error', `Error: ${event.error}`);
                    updateVoiceButton('ready', '🎤 Start Voice Control');
                    isListening = false;
                };
                
                recognition.onend = function() {
                    isListening = false;
                    updateVoiceStatus('ready', 'Voice control ready');
                    updateVoiceButton('ready', '🎤 Start Voice Control');
                    document.getElementById('voiceCommand').classList.remove('active');
                };
                
                voiceSupported = true;
                updateVoiceStatus('ready', 'Voice control ready');
            } else {
                voiceSupported = false;
                updateVoiceStatus('error', 'Speech recognition not supported');
                document.getElementById('voiceToggleBtn').disabled = true;
                document.getElementById('voiceToggleBtn').textContent = '🎤 Not Supported';
            }
        }

        function toggleVoiceRecognition() {
            if (!voiceSupported) return;
            
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Failed to start recognition:', error);
                    updateVoiceStatus('error', 'Failed to start voice recognition');
                }
            }
        }

        function updateVoiceStatus(status, message) {
            const statusDiv = document.getElementById('voiceStatus');
            statusDiv.className = `voice-status ${status}`;
            statusDiv.textContent = message;
        }

        function updateVoiceButton(status, text) {
            const btn = document.getElementById('voiceToggleBtn');
            btn.className = `voice-btn ${status}`;
            btn.textContent = text;
        }

        function processVoiceCommand(command) {
            if (!isConnected) {
                addToLog('Voice command ignored: Not connected to robot');
                return;
            }
            
            addToLog(`Voice command: "${command}"`);
            
            const lowerCommand = command.toLowerCase();
            
            // Basic commands
            if (lowerCommand.includes('stand')) {
                sendCommand('stand');
                addToLog('Executed: stand');
            } else if (lowerCommand.includes('sit')) {
                sendCommand('sit');
                addToLog('Executed: sit');
            } else if (lowerCommand.includes('walk')) {
                sendCommand('walk');
                addToLog('Executed: walk');
            } else if (lowerCommand.includes('neutral')) {
                sendCommand('neutral');
                addToLog('Executed: neutral');
            } else if (lowerCommand.includes('down')) {
                sendCommand('down');
                addToLog('Executed: down');
            }
            // Sequence commands
            else if (lowerCommand.includes('execute sequence') || lowerCommand.includes('run sequence')) {
                if (currentSequence.length > 0) {
                    executeSequence();
                    addToLog('Executed: sequence');
                } else {
                    addToLog('No sequence to execute');
                }
            } else if (lowerCommand.includes('dance')) {
                loadPreset('dance');
                executeSequence();
                addToLog('Executed: dance sequence');
            } else if (lowerCommand.includes('wave')) {
                loadPreset('wave');
                executeSequence();
                addToLog('Executed: wave sequence');
            } else if (lowerCommand.includes('exercise')) {
                loadPreset('exercise');
                executeSequence();
                addToLog('Executed: exercise sequence');
            }
            // Leg control commands
            else if (lowerCommand.includes('move leg') || lowerCommand.includes('leg')) {
                processLegVoiceCommand(lowerCommand);
            }
            // Help command
            else if (lowerCommand.includes('help') || lowerCommand.includes('commands')) {
                sendCommand('help');
                addToLog('Executed: help');
            }
            else {
                addToLog(`Unknown voice command: "${command}"`);
            }
        }

        function processLegVoiceCommand(command) {
            // Parse commands like "move leg 0 hip 30" or "leg 1 knee 45"
            const legMatch = command.match(/leg\s*(\d+)\s*(hip|knee)\s*(-?\d+)/);
            
            if (legMatch) {
                const legId = parseInt(legMatch[1]);
                const joint = legMatch[2];
                const angle = parseFloat(legMatch[3]);
                
                if (legId >= 0 && legId <= 3 && angle >= -90 && angle <= 90) {
                    moveLeg(legId, joint, angle);
                    addToLog(`Voice executed: leg ${legId} ${joint} ${angle}`);
                } else {
                    addToLog(`Invalid leg command: leg ${legId} ${joint} ${angle}`);
                }
            } else {
                addToLog('Could not parse leg command. Try: "move leg 0 hip 30"');
            }
        }

        function moveLeg(legId, joint, angle) {
            if (!isConnected) {
                alert('Please connect to the robot first');
                return;
            }

            socket.emit('robot-command', { 
                command: 'leg', 
                legId: legId, 
                joint: joint, 
                angle: angle 
            });
            
            addToLog(`Sent: leg ${legId} ${joint} ${angle}`);
        }

        // Initialize voice recognition when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeVoiceRecognition();
            
            // Add event listener for voice toggle button
            document.getElementById('voiceToggleBtn').addEventListener('click', toggleVoiceRecognition);
        });

        // Initialize
        refreshPorts();
    </script>
</body>
</html>
